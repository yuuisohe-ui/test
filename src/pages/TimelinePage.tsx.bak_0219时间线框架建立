import { useState, useEffect, useRef } from "react";

// æœä»£æ•°æ®ç±»å‹
interface Dynasty {
  id: string;
  name: string;
  period: string;
  badge?: string;
  backgroundImage?: string;
  videoId?: string;
  videoIds?: string[];
  lyrics?: {
    chinese: string[];
    korean: string[];
  };
  idioms?: string[];
  greeting?: string; // AIé—®å€™è¯­
}

// æœä»£æ•°æ®
const dynasties: Dynasty[] = [
  {
    id: "1",
    name: "å…ˆç§¦",
    period: "BC2100â€“221",
    badge: "ç²‰å¢¨ç™»åœº Â· æˆæ›²",
    backgroundImage: "https://images.unsplash.com/photo-1547036967-23d11aacaee0?w=800&q=60",
    videoId: "yKNxeF4KMsY",
    lyrics: {
      chinese: ["æˆä¸€æŠ˜ æ°´è¢–èµ·è½", "ç²‰å¢¨ç™»åœº è‹±é›„æ˜¯ä¸é"],
      korean: ["í•œ ê³¡ì˜ ì—°ê·¹, ìˆ˜ì†Œê°€ ì˜¤ë¥´ë‚´ë¦¬ë„¤", "ë¶„ì¥í•˜ê³  ë¬´ëŒ€ì— ì˜¤ë¥´ë‹ˆ ì˜ì›…ì˜ ì˜³ê³  ê·¸ë¦„ì´ ìˆë„¤"],
    },
    idioms: ["ç²‰å¢¨ç™»åœº"],
    greeting: "å…ˆç§¦æ—¶æœŸï¼Œæˆæ›²è‰ºæœ¯å¼€å§‹èŒèŠ½ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªæ—¶ä»£çš„æ–‡åŒ–ç‘°å®å§ï¼",
  },
  {
    id: "2",
    name: "æ±‰æœ",
    period: "BC206â€“AD220",
    badge: "å¤©é’è‰² Â· æ±çª‘ ë„ìê¸°",
    backgroundImage: "https://images.unsplash.com/photo-1551029506-0807df4e2031?w=800&q=60",
    videoId: "mesKsB2VmHE",
    lyrics: {
      chinese: ["å¤©é’è‰²ç­‰çƒŸé›¨ è€Œæˆ‘åœ¨ç­‰ä½ ", "åœ¨ç“¶åº•ä¹¦æ±‰éš¶ ä»¿å‰æœçš„é£˜é€¸"],
      korean: ["í•˜ëŠ˜ë¹›ì€ ì•ˆê°œë¹„ë¥¼ ê¸°ë‹¤ë¦¬ê³ , ë‚˜ëŠ” ë„ˆë¥¼ ê¸°ë‹¤ë¦¬ë„¤", "ë³‘ ë°”ë‹¥ì— í•œë‚˜ë¼ ì˜ˆì„œë¥¼ ì“°ë‹ˆ, ì „ì¡°ì˜ í‘œì¼ì²´ë¥¼ ëª¨ë°©í•˜ë„¤"],
    },
    idioms: ["å¤©é’è‰²", "åœ¨ç“¶åº•ä¹¦æ±‰éš¶"],
    greeting: "æ±‰æœæ˜¯ä¸­åæ–‡æ˜çš„é‡è¦æ—¶æœŸï¼Œé’èŠ±ç“·çš„ç¾ä¸½è‡³ä»Šä»è®©äººèµå¹ã€‚",
  },
  {
    id: "3",
    name: "å”æœ",
    period: "AD618â€“907",
    badge: "æ˜æœˆ Â· è¯—è¯",
    backgroundImage: "https://images.unsplash.com/photo-1508804185872-d7badad00f7d?w=800&q=60",
    videoId: "SiMMmjdKbHQ",
    lyrics: {
      chinese: ["äººæœ‰æ‚²æ¬¢ç¦»åˆ æœˆæœ‰é˜´æ™´åœ†ç¼º", "æ­¤äº‹å¤éš¾å…¨"],
      korean: ["ì‚¬ëŒì—ê²ŒëŠ” ìŠ¬í””ê³¼ ê¸°ì¨, ì´ë³„ê³¼ ë§Œë‚¨ì´ ìˆê³ , ë‹¬ì—ëŠ” íë¦¬ê³  ë§‘ìŒ, ë‘¥ê¸€ê³  ì´ì§€ëŸ¬ì§ì´ ìˆë„¤", "ì´ëŸ° ì¼ì€ ì˜ˆë¡œë¶€í„° ì™„ë²½í•˜ê¸° ì–´ë µë„¤"],
    },
    idioms: ["äººæœ‰æ‚²æ¬¢ç¦»åˆ"],
    greeting: "å”æœæ˜¯è¯—æ­Œçš„é»„é‡‘æ—¶ä»£ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ„Ÿå—é‚£ä¸ªæ—¶ä»£çš„è¯—æ„å§ï¼",
  },
  {
    id: "4",
    name: "å®‹æœ",
    period: "AD960â€“1279",
    badge: "è¡Œäº‘æµæ°´ Â· ä¹¦æ³•",
    backgroundImage: "https://images.unsplash.com/photo-1565193566173-7a0ee3dbe261?w=800&q=60",
    videoIds: ["mesKsB2VmHE", "hs95KBpRHCU"],
    lyrics: {
      chinese: ["è¡Œäº‘æµæ°´ å¿˜äº†å²æœˆå¿˜äº†æ—¶é—´", "å…°äº­ä¸´å¸– è¡Œä¹¦å¦‚è¡Œäº‘æµæ°´"],
      korean: ["êµ¬ë¦„ì²˜ëŸ¼ íë¥´ê³  ë¬¼ì²˜ëŸ¼ íë¥´ë‹ˆ, ì„¸ì›”ì„ ìŠê³  ì‹œê°„ì„ ìŠë„¤", "ë‚œì •ì—ì„œ ê¸€ì”¨ë¥¼ ëª¨ì‚¬í•˜ë‹ˆ í–‰ì„œê°€ êµ¬ë¦„ì²˜ëŸ¼ íë¥´ê³  ë¬¼ì²˜ëŸ¼ íë¥´ë„¤"],
    },
    idioms: ["è¡Œäº‘æµæ°´"],
    greeting: "å®‹æœçš„ä¹¦æ³•è‰ºæœ¯è¾¾åˆ°äº†å·…å³°ï¼Œè¡Œäº‘æµæ°´çš„ç¬”è§¦è‡³ä»Šä»è®©äººç€è¿·ã€‚",
  },
  {
    id: "5",
    name: "å…ƒæœ",
    period: "AD1271â€“1368",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "å…ƒæœæ—¶æœŸçš„æ–‡åŒ–èåˆï¼Œä¸ºä¸­åæ–‡æ˜å¢æ·»äº†æ–°çš„è‰²å½©ã€‚",
  },
  {
    id: "6",
    name: "æ˜æœ",
    period: "AD1368â€“1644",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "æ˜æœæ˜¯ä¸­åæ–‡æ˜çš„åˆä¸€ä¸ªé«˜å³°ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªæ—¶ä»£ã€‚",
  },
  {
    id: "7",
    name: "æ¸…æœ",
    period: "AD1644â€“1912",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "æ¸…æœæ—¶æœŸçš„æ–‡åŒ–ä¼ æ‰¿ï¼Œä¸ºæˆ‘ä»¬ç•™ä¸‹äº†ä¸°å¯Œçš„æ–‡åŒ–é—äº§ã€‚",
  },
  {
    id: "8",
    name: "æ°‘å›½",
    period: "AD1912â€“1949",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "æ°‘å›½æ—¶æœŸæ˜¯æ–‡åŒ–è½¬å‹çš„é‡è¦é˜¶æ®µï¼Œæ–°æ–‡åŒ–è¿åŠ¨å½±å“æ·±è¿œã€‚",
  },
  {
    id: "9",
    name: "ç°ä»£",
    period: "AD1949â€“è‡³ä»Š",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "ç°ä»£ä¸­å›½ï¼Œä¼ ç»Ÿæ–‡åŒ–ä¸ç°ä»£æ–‡æ˜äº¤ç›¸è¾‰æ˜ ã€‚",
  },
  {
    id: "10",
    name: "æœªæ¥",
    period: "æœªæ¥",
    backgroundImage: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=60",
    greeting: "æœªæ¥ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä¼ æ‰¿å’Œå‘æ‰¬ä¸­åæ–‡åŒ–çš„ç²¾é«“ã€‚",
  },
];

// æ¶ˆæ¯ç±»å‹
interface Message {
  id: string;
  type: "ai" | "user";
  content: string;
  timestamp: Date;
}

export default function TimelinePage() {
  const [showIntro, setShowIntro] = useState(true);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [playingVideoId, setPlayingVideoId] = useState<string | null>(null);
  const [showAIPanel, setShowAIPanel] = useState(false);
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputValue, setInputValue] = useState("");
  const cardRefs = useRef<(HTMLDivElement | null)[]>([]);
  const [visibleCards, setVisibleCards] = useState<Set<number>>(new Set());
  const [introElementsVisible, setIntroElementsVisible] = useState({
    square: false,
    title: false,
    subtitle: false,
    button: false,
  });
  const [buttonHovered, setButtonHovered] = useState(false);
  const [playButtonHovered, setPlayButtonHovered] = useState<Record<string, boolean>>({});
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // å…¥åœºåŠ¨ç”»å…ƒç´ ä¾æ¬¡æ˜¾ç¤º
  useEffect(() => {
    if (!showIntro) return;

    const timers = [
      setTimeout(() => setIntroElementsVisible((prev) => ({ ...prev, square: true })), 200),
      setTimeout(() => setIntroElementsVisible((prev) => ({ ...prev, title: true })), 400),
      setTimeout(() => setIntroElementsVisible((prev) => ({ ...prev, subtitle: true })), 600),
      setTimeout(() => setIntroElementsVisible((prev) => ({ ...prev, button: true })), 800),
    ];

    return () => {
      timers.forEach((timer) => clearTimeout(timer));
    };
  }, [showIntro]);

  // IntersectionObserver ç”¨äºæ·¡å…¥åŠ¨ç”»
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const index = cardRefs.current.indexOf(entry.target as HTMLDivElement);
            if (index !== -1) {
              setVisibleCards((prev) => new Set([...prev, index]));
            }
          }
        });
      },
      { threshold: 0.1 }
    );

    cardRefs.current.forEach((ref) => {
      if (ref) observer.observe(ref);
    });

    return () => {
      cardRefs.current.forEach((ref) => {
        if (ref) observer.unobserve(ref);
      });
    };
  }, []);

  // æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // åˆ‡æ¢å±•å¼€çŠ¶æ€ï¼ˆæ‰‹é£ç´æ•ˆæœï¼‰
  const toggleExpand = (id: string) => {
    setExpandedId(expandedId === id ? null : id);
    setPlayingVideoId(null);

    // æ˜¾ç¤ºAIé—®å€™è¯­
    const dynasty = dynasties.find((d) => d.id === id);
    if (dynasty && dynasty.greeting && expandedId !== id) {
      setShowAIPanel(true);
      setTimeout(() => {
        setMessages([
          {
            id: Date.now().toString(),
            type: "ai",
            content: dynasty.greeting,
            timestamp: new Date(),
          },
        ]);
      }, 100);
    }
  };

  // ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ’­æ”¾è§†é¢‘
  const handlePlayClick = (videoId: string, e: React.MouseEvent) => {
    e.stopPropagation();
    setPlayingVideoId(videoId);
  };

  // é«˜äº®æˆè¯­ï¼ˆå¸¦ä¸‹åˆ’çº¿ï¼‰
  const highlightIdioms = (text: string, idioms: string[] = []) => {
    if (idioms.length === 0) return text;
    let result = text;
    idioms.forEach((idiom) => {
      const regex = new RegExp(`(${idiom})`, "g");
      result = result.replace(
        regex,
        '<span style="color: #c9a84c; border-bottom: 1px solid rgba(201,168,76,0.5); cursor: pointer;">$1</span>'
      );
    });
    return result;
  };

  // å¤„ç†æˆè¯­ç‚¹å‡»
  const handleIdiomClick = (idiom: string) => {
    setShowAIPanel(true);
    const newMessage: Message = {
      id: Date.now().toString(),
      type: "user",
      content: `è¯·å‘Šè¯‰æˆ‘å…³äº"${idiom}"çš„å…¸æ•…å’Œæ•…äº‹ã€‚`,
      timestamp: new Date(),
    };
    setMessages((prev) => [...prev, newMessage]);

    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
      const aiReply: Message = {
        id: (Date.now() + 1).toString(),
        type: "ai",
        content: `"${idiom}"æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„ä¹‰çš„æˆè¯­ã€‚è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šå®ƒçš„å…¸æ•…å’Œå«ä¹‰...`,
        timestamp: new Date(),
      };
      setMessages((prev) => [...prev, aiReply]);
    }, 1000);
  };

  // å‘é€æ¶ˆæ¯
  const handleSendMessage = () => {
    if (!inputValue.trim()) return;

    const newMessage: Message = {
      id: Date.now().toString(),
      type: "user",
      content: inputValue,
      timestamp: new Date(),
    };
    setMessages((prev) => [...prev, newMessage]);
    setInputValue("");

    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
      const aiReply: Message = {
        id: (Date.now() + 1).toString(),
        type: "ai",
        content: "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£ç­”...",
        timestamp: new Date(),
      };
      setMessages((prev) => [...prev, aiReply]);
    }, 1000);
  };

  // å¤„ç†"ìƒì„¸íˆ ë°°ìš°ê¸°"æŒ‰é’®ç‚¹å‡»
  const handleLearnMore = (e: React.MouseEvent) => {
    e.stopPropagation();
    alert("ì¤€ë¹„ ì¤‘");
  };

  // å…³é—­å…¥åœºåŠ¨ç”»
  const handleStartClick = () => {
    setShowIntro(false);
  };

  return (
    <div style={{ minHeight: "100vh", backgroundColor: "#0c0b08", color: "#f0ead8", position: "relative" }}>
      {/* å…¥åœºåŠ¨ç”»é¡µ - å…¨å±é®ç½© */}
      {showIntro && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            backgroundColor: "#0c0b08",
            zIndex: 50,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            transition: "opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
            opacity: showIntro ? 1 : 0,
          }}
        >
          <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: "32px" }}>
            <div
              style={{
                opacity: introElementsVisible.square ? 1 : 0,
                transform: introElementsVisible.square ? "translateY(0)" : "translateY(16px)",
                transition: "all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
              }}
            >
              <div
                className="stamp-box"
                style={{
                  width: "110px",
                  height: "110px",
                  border: "1.5px solid #c9a84c",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  position: "relative",
                }}
              >
                <span
                  style={{
                    fontFamily: "'Ma Shan Zheng', serif",
                    fontSize: "54px",
                    color: "#c9a84c",
                  }}
                >
                  è¯
                </span>
              </div>
            </div>

            <h1
              style={{
                fontFamily: "'Ma Shan Zheng', serif",
                fontSize: "72px",
                color: "#f0ead8",
                letterSpacing: "20px",
                opacity: introElementsVisible.title ? 1 : 0,
                transform: introElementsVisible.title ? "translateY(0)" : "translateY(16px)",
                transition: "all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
                margin: 0,
              }}
            >
              è¯éŸµ
            </h1>

            <p
              style={{
                fontSize: "12px",
                letterSpacing: "6px",
                color: "#7a7060",
                opacity: introElementsVisible.subtitle ? 1 : 0,
                transform: introElementsVisible.subtitle ? "translateY(0)" : "translateY(16px)",
                transition: "all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
                margin: 0,
              }}
            >
              æ­·å²ë¡œ ë“£ëŠ” ì¤‘êµ­ ë…¸ë˜
            </p>

            <button
              onClick={handleStartClick}
              onMouseEnter={() => setButtonHovered(true)}
              onMouseLeave={() => setButtonHovered(false)}
              style={{
                position: "relative",
                padding: "12px 32px",
                border: "1px solid #c9a84c",
                backgroundColor: "transparent",
                overflow: "hidden",
                cursor: "pointer",
                opacity: introElementsVisible.button ? 1 : 0,
                transform: introElementsVisible.button ? "translateY(0)" : "translateY(16px)",
                transition: "all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
              }}
            >
              <span
                style={{
                  position: "relative",
                  zIndex: 10,
                  color: buttonHovered ? "#0c0b08" : "#c9a84c",
                  transition: "color 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                }}
              >
                âœ¦ ì‹œì‘í•˜ê¸° âœ¦
              </span>
              <span
                style={{
                  position: "absolute",
                  inset: 0,
                  backgroundColor: "#c9a84c",
                  transform: buttonHovered ? "translateX(0)" : "translateX(-100%)",
                  transition: "transform 0.5s cubic-bezier(0.16, 1, 0.3, 1)",
                }}
              ></span>
            </button>
          </div>
        </div>
      )}

      {/* æ—¶é—´çº¿åŒºåŸŸ */}
      <div style={{ width: "100%", maxWidth: "1100px", margin: "0 auto", padding: "0 48px" }}>
        {/* Header */}
        <div style={{ padding: "48px 0 64px 0" }}>
          <p
            style={{
              fontSize: "10px",
              color: "#c9a84c",
              letterSpacing: "4px",
              margin: "0 0 24px 0",
            }}
          >
            æ­·å²æ™‚é–“ç·š Â· ì—­ì‚¬ íƒ€ì„ë¼ì¸
          </p>
          <h1
            style={{
              fontFamily: "'Ma Shan Zheng', serif",
              fontSize: "48px",
              color: "#f0ead8",
              letterSpacing: "6px",
              margin: "0 0 24px 0",
              lineHeight: 1.45,
              maxWidth: "680px",
              textAlign: "left",
            }}
          >
            ê·¸ ì‹œëŒ€ì˜ ì´ì•¼ê¸°ê°€
            <br />
            ì˜¤ëŠ˜ì˜ ë…¸ë˜ê°€ ëìŠµë‹ˆë‹¤
          </h1>
            <p style={{ fontSize: "14px", color: "#7a7060", margin: "8px 0", lineHeight: 1.6 }}>
              æ™‚ä»£ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ê·¸ ì•ˆì— ìˆ¨ê²¨ì§„ ë…¸ë˜ì™€ ì„±ì–´ê°€ í¼ì³ì§‘ë‹ˆë‹¤
            </p>
            <p style={{ fontSize: "14px", color: "#7a7060", margin: "8px 0", lineHeight: 1.6 }}>
              ê°€ì‚¬ ì† ê¸ˆìƒ‰ ë‹¨ì–´ë¥¼ í´ë¦­í•˜ë©´ ì „ê³  ì´ì•¼ê¸°ì™€ AI ëŒ€í™”ê°€ ì‹œì‘ë©ë‹ˆë‹¤
            </p>
          </div>

          {/* ä¸­é—´è„Šçº¿ */}
          <div
            style={{
              position: "absolute",
              left: "50%",
              top: 0,
              bottom: 0,
              width: "1px",
              background: "linear-gradient(to bottom, transparent, #6b5520 8%, #6b5520 92%, transparent)",
              transform: "translateX(-50%)",
              zIndex: 1,
            }}
          ></div>

          {/* æœä»£è¡Œ */}
          {dynasties.map((dynasty, index) => {
            const isLeft = index % 2 === 0;
            const isExpanded = expandedId === dynasty.id;
            const isVisible = visibleCards.has(index);
            const hasContent = dynasty.videoId || dynasty.videoIds;

            return (
              <div key={dynasty.id} style={{ marginBottom: "48px", position: "relative" }}>
                {/* æœä»£è¡Œ - Gridå¸ƒå±€ */}
                <div
                  style={{
                    display: "grid",
                    gridTemplateColumns: "1fr 60px 1fr",
                    position: "relative",
                  }}
                >
                  {/* å·¦ä¾§åˆ— */}
                  <div
                    style={{
                      paddingRight: "24px",
                      display: "flex",
                      justifyContent: "flex-end",
                    }}
                  >
                    {isLeft && (
                      <div
                        ref={(el) => {
                          cardRefs.current[index] = el;
                        }}
                        style={{
                          width: "100%",
                          maxWidth: "440px",
                          transition: "all 1s cubic-bezier(0.16, 1, 0.3, 1)",
                          opacity: isVisible ? 1 : 0,
                          transform: isVisible ? "translateY(0)" : "translateY(40px)",
                        }}
                      >
                        {/* æœä»£å¡ç‰‡ */}
                        <div
                          onClick={() => toggleExpand(dynasty.id)}
                          style={{
                            width: "100%",
                            height: "220px",
                            position: "relative",
                            overflow: "hidden",
                            cursor: "pointer",
                            border: isExpanded
                              ? "1px solid rgba(201,168,76,0.4)"
                              : "1px solid rgba(201,168,76,0.15)",
                            transition: "all 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.borderColor = "rgba(201,168,76,0.4)";
                            const img = e.currentTarget.querySelector("img");
                            if (img) img.style.filter = "brightness(1.1)";
                          }}
                          onMouseLeave={(e) => {
                            if (!isExpanded) {
                              e.currentTarget.style.borderColor = "rgba(201,168,76,0.15)";
                              const img = e.currentTarget.querySelector("img");
                              if (img) img.style.filter = "brightness(1)";
                            }
                          }}
                        >
                          {/* èƒŒæ™¯å›¾ç‰‡ */}
                          {dynasty.backgroundImage && (
                            <>
                              <img
                                src={dynasty.backgroundImage}
                                alt={dynasty.name}
                                style={{
                                  position: "absolute",
                                  inset: 0,
                                  width: "100%",
                                  height: "100%",
                                  objectFit: "cover",
                                  transition: "filter 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
                                }}
                              />
                              <div
                                style={{
                                  position: "absolute",
                                  inset: 0,
                                  background:
                                    "linear-gradient(160deg, rgba(12,11,8,0.85) 0%, rgba(12,11,8,0.15) 70%, transparent)",
                                }}
                              ></div>
                            </>
                          )}

                          {/* å³ä¸Šè§’badge */}
                          {dynasty.badge && (
                            <div
                              style={{
                                position: "absolute",
                                top: "14px",
                                right: "14px",
                              }}
                            >
                              <span
                                style={{
                                  padding: "4px 10px",
                                  backgroundColor: "rgba(201,168,76,0.2)",
                                  backdropFilter: "blur(4px)",
                                  border: "1px solid rgba(201,168,76,0.4)",
                                  borderRadius: "12px",
                                  fontSize: "11px",
                                  color: "#c9a84c",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {dynasty.badge}
                              </span>
                            </div>
                          )}

                          {/* æœä»£åç§°å’Œå¹´ä»£ - å·¦ä¸‹è§’ */}
                          <div
                            style={{
                              position: "absolute",
                              bottom: "20px",
                              left: "22px",
                            }}
                          >
                            <h2
                              style={{
                                fontFamily: "'Ma Shan Zheng', serif",
                                fontSize: "48px",
                                color: "#c9a84c",
                                textShadow: "0 2px 16px rgba(0,0,0,0.9)",
                                margin: 0,
                                lineHeight: 1,
                              }}
                            >
                              {dynasty.name}
                            </h2>
                            <p
                              style={{
                                fontSize: "9px",
                                color: "#b8ad98",
                                margin: "4px 0 0 0",
                              }}
                            >
                              {dynasty.period}
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* ä¸­é—´åˆ— - åœ†ç‚¹å’Œå¹´ä»£ */}
                  <div
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      paddingTop: "32px",
                      position: "relative",
                      zIndex: 2,
                    }}
                  >
                    <div
                      style={{
                        width: "20px",
                        height: "20px",
                        borderRadius: "50%",
                        border: "2px solid #6b5520",
                        backgroundColor: isExpanded ? "#c9a84c" : "transparent",
                        transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                      }}
                    ></div>
                    <p
                      style={{
                        fontSize: "9px",
                        color: "#6b5520",
                        whiteSpace: "nowrap",
                        margin: "8px 0 0 0",
                      }}
                    >
                      {dynasty.period}
                    </p>
                  </div>

                  {/* å³ä¾§åˆ— */}
                  <div
                    style={{
                      paddingLeft: "24px",
                      display: "flex",
                      justifyContent: "flex-start",
                    }}
                  >
                    {!isLeft && (
                      <div
                        ref={(el) => {
                          cardRefs.current[index] = el;
                        }}
                        style={{
                          width: "100%",
                          maxWidth: "440px",
                          transition: "all 1s cubic-bezier(0.16, 1, 0.3, 1)",
                          opacity: isVisible ? 1 : 0,
                          transform: isVisible ? "translateY(0)" : "translateY(40px)",
                        }}
                      >
                        {/* æœä»£å¡ç‰‡ */}
                        <div
                          onClick={() => toggleExpand(dynasty.id)}
                          style={{
                            width: "100%",
                            height: "220px",
                            position: "relative",
                            overflow: "hidden",
                            cursor: "pointer",
                            border: isExpanded
                              ? "1px solid rgba(201,168,76,0.4)"
                              : "1px solid rgba(201,168,76,0.15)",
                            transition: "all 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.borderColor = "rgba(201,168,76,0.4)";
                            const img = e.currentTarget.querySelector("img");
                            if (img) img.style.filter = "brightness(1.1)";
                          }}
                          onMouseLeave={(e) => {
                            if (!isExpanded) {
                              e.currentTarget.style.borderColor = "rgba(201,168,76,0.15)";
                              const img = e.currentTarget.querySelector("img");
                              if (img) img.style.filter = "brightness(1)";
                            }
                          }}
                        >
                          {/* èƒŒæ™¯å›¾ç‰‡ */}
                          {dynasty.backgroundImage && (
                            <>
                              <img
                                src={dynasty.backgroundImage}
                                alt={dynasty.name}
                                style={{
                                  position: "absolute",
                                  inset: 0,
                                  width: "100%",
                                  height: "100%",
                                  objectFit: "cover",
                                  transition: "filter 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
                                }}
                              />
                              <div
                                style={{
                                  position: "absolute",
                                  inset: 0,
                                  background:
                                    "linear-gradient(160deg, rgba(12,11,8,0.85) 0%, rgba(12,11,8,0.15) 70%, transparent)",
                                }}
                              ></div>
                            </>
                          )}

                          {/* å³ä¸Šè§’badge */}
                          {dynasty.badge && (
                            <div
                              style={{
                                position: "absolute",
                                top: "14px",
                                right: "14px",
                              }}
                            >
                              <span
                                style={{
                                  padding: "4px 10px",
                                  backgroundColor: "rgba(201,168,76,0.2)",
                                  backdropFilter: "blur(4px)",
                                  border: "1px solid rgba(201,168,76,0.4)",
                                  borderRadius: "12px",
                                  fontSize: "11px",
                                  color: "#c9a84c",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {dynasty.badge}
                              </span>
                            </div>
                          )}

                          {/* æœä»£åç§°å’Œå¹´ä»£ - å·¦ä¸‹è§’ */}
                          <div
                            style={{
                              position: "absolute",
                              bottom: "20px",
                              left: "22px",
                            }}
                          >
                            <h2
                              style={{
                                fontFamily: "'Ma Shan Zheng', serif",
                                fontSize: "48px",
                                color: "#c9a84c",
                                textShadow: "0 2px 16px rgba(0,0,0,0.9)",
                                margin: 0,
                                lineHeight: 1,
                              }}
                            >
                              {dynasty.name}
                            </h2>
                            <p
                              style={{
                                fontSize: "9px",
                                color: "#b8ad98",
                                margin: "4px 0 0 0",
                              }}
                            >
                              {dynasty.period}
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* å±•å¼€å†…å®¹ - åœ¨å¡ç‰‡ä¸‹æ–¹ï¼Œå®½åº¦é™åˆ¶ */}
                <div
                  style={{
                    display: "grid",
                    gridTemplateColumns: "1fr 60px 1fr",
                    overflow: "hidden",
                    maxHeight: isExpanded ? "900px" : "0",
                    transition: "max-height 0.6s cubic-bezier(0.16, 1, 0.3, 1)",
                  }}
                >
                  <div
                    style={{
                      gridColumn: isLeft ? "1 / 2" : "3 / 4",
                      maxWidth: "600px",
                      ...(isLeft
                        ? { marginRight: "auto", paddingRight: "24px" }
                        : { marginLeft: "auto", paddingLeft: "24px" }),
                    }}
                  >
                    <div
                      style={{
                        padding: "24px",
                        background: "rgba(255,255,255,0.02)",
                        border: "1px solid rgba(201,168,76,0.1)",
                        borderRadius: "8px",
                        marginTop: "16px",
                      }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      {hasContent ? (
                        <>
                          {/* YouTube è§†é¢‘åŒºåŸŸ */}
                          <div style={{ marginBottom: "24px" }}>
                            {dynasty.videoId && (
                              <div
                                style={{
                                  aspectRatio: "16/9",
                                  width: "100%",
                                  maxWidth: "440px",
                                  backgroundColor: "#000",
                                  borderRadius: "8px",
                                  overflow: "hidden",
                                  position: "relative",
                                  backgroundImage: dynasty.backgroundImage
                                    ? `url(${dynasty.backgroundImage})`
                                    : "none",
                                  backgroundSize: "cover",
                                  backgroundPosition: "center",
                                }}
                              >
                                {dynasty.backgroundImage && (
                                  <div
                                    style={{
                                      position: "absolute",
                                      inset: 0,
                                      backgroundColor: "rgba(0,0,0,0.6)",
                                    }}
                                  ></div>
                                )}
                                {playingVideoId === dynasty.videoId ? (
                                  <iframe
                                    src={`https://www.youtube.com/embed/${dynasty.videoId}?autoplay=1`}
                                    style={{
                                      position: "absolute",
                                      inset: 0,
                                      width: "100%",
                                      height: "100%",
                                      border: "none",
                                    }}
                                    allow="autoplay;fullscreen"
                                    allowFullScreen
                                  ></iframe>
                                ) : (
                                  <div
                                    style={{
                                      position: "absolute",
                                      inset: 0,
                                      display: "flex",
                                      alignItems: "center",
                                      justifyContent: "center",
                                      cursor: "pointer",
                                    }}
                                    onClick={(e) => handlePlayClick(dynasty.videoId!, e)}
                                    onMouseEnter={() =>
                                      setPlayButtonHovered((prev) => ({
                                        ...prev,
                                        [dynasty.videoId!]: true,
                                      }))
                                    }
                                    onMouseLeave={() =>
                                      setPlayButtonHovered((prev) => ({
                                        ...prev,
                                        [dynasty.videoId!]: false,
                                      }))
                                    }
                                  >
                                    <div
                                      style={{
                                        width: "64px",
                                        height: "64px",
                                        borderRadius: "50%",
                                        border: "1.5px solid #c9a84c",
                                        backgroundColor: playButtonHovered[dynasty.videoId!]
                                          ? "#c9a84c"
                                          : "transparent",
                                        display: "flex",
                                        alignItems: "center",
                                        justifyContent: "center",
                                        boxShadow: "0 4px 6px rgba(0,0,0,0.3)",
                                        transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                                      }}
                                    >
                                      <svg
                                        style={{
                                          width: "32px",
                                          height: "32px",
                                          marginLeft: "4px",
                                          fill: playButtonHovered[dynasty.videoId!]
                                            ? "#0c0b08"
                                            : "#c9a84c",
                                          transition: "fill 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                                        }}
                                        viewBox="0 0 24 24"
                                      >
                                        <path d="M8 5v14l11-7z" />
                                      </svg>
                                    </div>
                                  </div>
                                )}
                              </div>
                            )}

                            {dynasty.videoIds && (
                              <div
                                style={{
                                  display: "grid",
                                  gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))",
                                  gap: "16px",
                                }}
                              >
                                {dynasty.videoIds.map((videoId, vidIndex) => (
                                  <div
                                    key={vidIndex}
                                    style={{
                                      aspectRatio: "16/9",
                                      width: "100%",
                                      backgroundColor: "#000",
                                      borderRadius: "8px",
                                      overflow: "hidden",
                                      position: "relative",
                                      backgroundImage: dynasty.backgroundImage
                                        ? `url(${dynasty.backgroundImage})`
                                        : "none",
                                      backgroundSize: "cover",
                                      backgroundPosition: "center",
                                    }}
                                  >
                                    {dynasty.backgroundImage && (
                                      <div
                                        style={{
                                          position: "absolute",
                                          inset: 0,
                                          backgroundColor: "rgba(0,0,0,0.6)",
                                        }}
                                      ></div>
                                    )}
                                    {playingVideoId === videoId ? (
                                      <iframe
                                        src={`https://www.youtube.com/embed/${videoId}?autoplay=1`}
                                        style={{
                                          position: "absolute",
                                          inset: 0,
                                          width: "100%",
                                          height: "100%",
                                          border: "none",
                                        }}
                                        allow="autoplay;fullscreen"
                                        allowFullScreen
                                      ></iframe>
                                    ) : (
                                      <div
                                        style={{
                                          position: "absolute",
                                          inset: 0,
                                          display: "flex",
                                          alignItems: "center",
                                          justifyContent: "center",
                                          cursor: "pointer",
                                        }}
                                        onClick={(e) => handlePlayClick(videoId, e)}
                                        onMouseEnter={() =>
                                          setPlayButtonHovered((prev) => ({
                                            ...prev,
                                            [videoId]: true,
                                          }))
                                        }
                                        onMouseLeave={() =>
                                          setPlayButtonHovered((prev) => ({
                                            ...prev,
                                            [videoId]: false,
                                          }))
                                        }
                                      >
                                        <div
                                          style={{
                                            width: "56px",
                                            height: "56px",
                                            borderRadius: "50%",
                                            border: "1.5px solid #c9a84c",
                                            backgroundColor: playButtonHovered[videoId]
                                              ? "#c9a84c"
                                              : "transparent",
                                            display: "flex",
                                            alignItems: "center",
                                            justifyContent: "center",
                                            boxShadow: "0 4px 6px rgba(0,0,0,0.3)",
                                            transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                                          }}
                                        >
                                          <svg
                                            style={{
                                              width: "28px",
                                              height: "28px",
                                              marginLeft: "4px",
                                              fill: playButtonHovered[videoId]
                                                ? "#0c0b08"
                                                : "#c9a84c",
                                              transition: "fill 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                                            }}
                                            viewBox="0 0 24 24"
                                          >
                                            <path d="M8 5v14l11-7z" />
                                          </svg>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* æ­Œè¯åŒºåŸŸ */}
                          {dynasty.lyrics && (
                            <div
                              style={{
                                marginBottom: "24px",
                                textAlign: "left",
                                padding: "16px 20px",
                              }}
                            >
                              {dynasty.lyrics.chinese.map((line, lineIndex) => (
                                <div
                                  key={lineIndex}
                                  style={{ marginBottom: "12px" }}
                                  onClick={(e) => {
                                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æˆè¯­
                                    const target = e.target as HTMLElement;
                                    if (target.tagName === "SPAN" && target.style.color === "rgb(201, 168, 76)") {
                                      const idiom = target.textContent || "";
                                      handleIdiomClick(idiom);
                                    }
                                  }}
                                >
                                  <p
                                    style={{
                                      fontSize: "14px",
                                      color: "#f0ead8",
                                      margin: 0,
                                      marginBottom: "4px",
                                    }}
                                    dangerouslySetInnerHTML={{
                                      __html: highlightIdioms(line, dynasty.idioms || []),
                                    }}
                                  ></p>
                                  {dynasty.lyrics?.korean[lineIndex] && (
                                    <p
                                      style={{
                                        fontSize: "11px",
                                        color: "#7a7060",
                                        margin: 0,
                                      }}
                                    >
                                      {dynasty.lyrics.korean[lineIndex]}
                                    </p>
                                  )}
                                </div>
                              ))}
                            </div>
                          )}

                          {/* "ì´ ë…¸ë˜ ìƒì„¸íˆ ë°°ìš°ê¸°" æŒ‰é’® */}
                          <button
                            onClick={handleLearnMore}
                            style={{
                              width: "100%",
                              padding: "12px",
                              border: "1px solid rgba(201,168,76,0.3)",
                              backgroundColor: "transparent",
                              color: "#6b5520",
                              borderRadius: "8px",
                              fontSize: "14px",
                              fontWeight: 500,
                              cursor: "pointer",
                              transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.backgroundColor = "rgba(201,168,76,0.08)";
                              e.currentTarget.style.color = "#c9a84c";
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.backgroundColor = "transparent";
                              e.currentTarget.style.color = "#6b5520";
                            }}
                          >
                            âœ¦ ì´ ë…¸ë˜ ìƒì„¸íˆ ë°°ìš°ê¸° â†’
                          </button>
                        </>
                      ) : (
                        <div
                          style={{
                            textAlign: "center",
                            padding: "48px 0",
                            color: "rgba(240,234,216,0.5)",
                          }}
                        >
                          <p style={{ fontSize: "18px", margin: 0 }}>
                            ì´ ì‹œëŒ€ì˜ ë…¸ë˜ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤ ğŸµ
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
      </div>

      {/* å³ä¸‹è§’æµ®åŠ¨èŠå¤©æ°”æ³¡ */}
      {/* èŠå¤©å¼¹çª— */}
      {showAIPanel && (
        <div
          style={{
            position: "fixed",
            bottom: "96px",
            right: "28px",
            width: "320px",
            height: "480px",
            backgroundColor: "#141210",
            border: "1px solid rgba(201,168,76,0.2)",
            boxShadow: "0 8px 40px rgba(0,0,0,0.6)",
            borderRadius: "12px",
            display: "flex",
            flexDirection: "column",
            zIndex: 100,
            opacity: showAIPanel ? 1 : 0,
            transform: showAIPanel ? "translateY(0)" : "translateY(12px)",
            transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
          }}
        >
          {/* é¡¶éƒ¨ */}
          <div
            style={{
              padding: "16px 20px",
              borderBottom: "1px solid rgba(201,168,76,0.15)",
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
            }}
          >
            <span style={{ fontSize: "13px", color: "#c9a84c", fontWeight: 500 }}>
              è‹å°è¯ AI íŠœí„°
            </span>
            <button
              onClick={() => setShowAIPanel(false)}
              style={{
                background: "none",
                border: "none",
                color: "#7a7060",
                cursor: "pointer",
                fontSize: "20px",
                padding: 0,
                width: "24px",
                height: "24px",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                transition: "color 0.2s",
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.color = "#f0ead8";
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.color = "#7a7060";
              }}
            >
              Ã—
            </button>
          </div>

          {/* æ¶ˆæ¯åŒº */}
          <div
            style={{
              flex: 1,
              overflowY: "auto",
              padding: "20px",
              display: "flex",
              flexDirection: "column",
              gap: "12px",
            }}
          >
            {messages.map((message) => (
              <div
                key={message.id}
                style={{
                  display: "flex",
                  justifyContent: message.type === "ai" ? "flex-start" : "flex-end",
                }}
              >
                <div
                  style={{
                    maxWidth: "80%",
                    padding: "10px 14px",
                    borderRadius: "12px",
                    backgroundColor:
                      message.type === "ai"
                        ? "rgba(201,168,76,0.1)"
                        : "rgba(201,168,76,0.2)",
                    color: "#f0ead8",
                    fontSize: "12px",
                    lineHeight: 1.5,
                  }}
                >
                  {message.content}
                </div>
              </div>
            ))}
            <div ref={messagesEndRef}></div>
          </div>

          {/* åº•éƒ¨ */}
          <div
            style={{
              padding: "16px",
              borderTop: "1px solid rgba(201,168,76,0.15)",
            }}
          >
            {/* è¾“å…¥æ¡† */}
            <div style={{ display: "flex", gap: "8px" }}>
              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === "Enter") {
                    handleSendMessage();
                  }
                }}
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                style={{
                  flex: 1,
                  padding: "10px 12px",
                  border: "1px solid rgba(201,168,76,0.3)",
                  backgroundColor: "rgba(255,255,255,0.04)",
                  color: "#f0ead8",
                  borderRadius: "8px",
                  fontSize: "12px",
                  outline: "none",
                }}
              />
              <button
                onClick={handleSendMessage}
                style={{
                  padding: "10px 16px",
                  border: "none",
                  backgroundColor: "#c9a84c",
                  color: "#0c0b08",
                  borderRadius: "8px",
                  fontSize: "12px",
                  cursor: "pointer",
                  fontWeight: 500,
                  transition: "all 0.2s",
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = "#d4b85a";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = "#c9a84c";
                }}
              >
                å‘é€
              </button>
            </div>
          </div>
        </div>
      )}

      {/* å³ä¸‹è§’æµ®åŠ¨æŒ‰é’® */}
      <button
        onClick={() => setShowAIPanel(!showAIPanel)}
        style={{
          position: "fixed",
          bottom: "28px",
          right: "28px",
          width: "56px",
          height: "56px",
          borderRadius: "50%",
          backgroundColor: "#ff6b9d",
          border: "none",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "24px",
          boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
          transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
          zIndex: 100,
        }}
        onMouseEnter={(e) => {
          e.currentTarget.style.transform = "scale(1.1)";
        }}
        onMouseLeave={(e) => {
          e.currentTarget.style.transform = "scale(1)";
        }}
      >
        ğŸ‘©â€ğŸ“
      </button>
    </div>
  );
}
